<div style="background-image: url('assets/main-background.jpg'); background-size: cover; background-position: center; background-repeat: no-repeat; min-height: 100vh; display: flex; flex-direction: column;">
  <header class="header d-flex justify-content-center align-items-center py-3 bg-light shadow-sm w-100">
    <nav class="nav flex-wrap justify-content-center">
      <a class="nav-link" [class.active]="activeSection == 'profil'" (click)="setActiveSection('profil')">Profil</a>
      <a class="nav-link" [class.active]="activeSection == 'vikendice'" (click)="setActiveSection('vikendice')">Vikendice</a>
      <a class="nav-link" [class.active]="activeSection == 'rezervacije'" (click)="setActiveSection('rezervacije')">Rezervacije</a>
      <a class="nav-link" href="/changePassword">Promeni lozinku</a>
      <a class="nav-link" (click)="odjaviSe()">Odjavi se</a>
    </nav>
  </header>

  <main class="flex-grow-1 d-flex justify-content-center align-items-start mt-3 mb-3">
        @if (activeSection == 'profil') {
          <div class="white-box">
            <div class="scrollable-content">
                <div class="profile-section d-flex flex-column flex-md-row gap-4">

                  <div class="profile-left text-center">
                    <img [src]="'http://localhost:4000/uploads/' + ulogovan.profilna_slika" alt="Profilna slika" class="profile-img">
                    @if (azuriranjeSlike == false) {
                      <button class="small-btn" (click)="setAzuriranjeSlike()">Azuriraj sliku</button>
                    } @else {
                      <input type="file" class="small-btn" (change)="onFileSelected($event)" accept="image/png, image/jpeg">
                      <button class="small-btn" (click)="azurirajSliku()">Azuriraj sliku</button>
                    }
                  </div>

                  <div class="profile-right">
                    <table class="profile-table">
                      <tr>
                        <td><strong>Ime:</strong></td>
                        <td>
                          @if (azuriranjeImena == false) { {{ ulogovan.ime }} }
                          @else { <input type="text" [(ngModel)]="korisnik.ime" [value]="ulogovan.ime"> }
                        </td>
                        <td>
                          @if (azuriranjeImena == false) { <button (click)="setAzuriranjeImena()">Azuriraj ime</button> }
                          @else { <button (click)="azurirajIme()">Azuriraj ime</button> }
                        </td>
                      </tr>
                      <tr>
                        <td><strong>Prezime:</strong></td>
                        <td>
                          @if (azuriranjePrezimena == false) { {{ ulogovan.prezime }} }
                          @else { <input type="text" [(ngModel)]="korisnik.prezime" [value]="ulogovan.prezime"> }
                        </td>
                        <td>
                          @if (azuriranjePrezimena == false) { <button (click)="setAzuriranjePrezimena()">Azuriraj prezime</button> }
                          @else { <button (click)="azurirajPrezime()">Azuriraj prezime</button> }
                        </td>
                      </tr>
                      <tr>
                        <td><strong>Adresa:</strong></td>
                        <td>
                          @if (azuriranjeAdrese == false) { {{ ulogovan.adresa }} }
                          @else { <input type="text" [(ngModel)]="korisnik.adresa" [value]="ulogovan.adresa"> }
                        </td>
                        <td>
                          @if (azuriranjeAdrese == false) { <button (click)="setAzuriranjeAdrese()">Azuriraj adresu</button> }
                          @else { <button (click)="azurirajAdresu()">Azuriraj adresu</button> }
                        </td>
                      </tr>
                      <tr>
                        <td><strong>Kontakt telefon:</strong></td>
                        <td>
                          @if (azuriranjeTelefona == false) { {{ ulogovan.kontakt_telefon }} }
                          @else { <input type="text" [(ngModel)]="korisnik.kontakt_telefon" [value]="ulogovan.kontakt_telefon"> }
                        </td>
                        <td>
                          @if (azuriranjeTelefona == false) { <button (click)="setAzuriranjeTelefona()">Azuriraj kontakt telefon</button> }
                          @else { <button (click)="azurirajTelefon()">Azuriraj kontakt telefon</button> }
                        </td>
                      </tr>
                      <tr>
                        <td><strong>E-mail:</strong></td>
                        <td>
                          @if (azuriranjeEMaila == false) { {{ ulogovan.mejl }} }
                          @else { <input type="text" [(ngModel)]="korisnik.mejl" [value]="ulogovan.mejl"> }
                        </td>
                        <td>
                          @if (azuriranjeEMaila == false) { <button (click)="setAzuriranjeEMaila()">Azuriraj E-mail</button> }
                          @else { <button (click)="azurirajEMail()">Azuriraj mail</button> }
                        </td>
                      </tr>

                      <tr>
                        <td><strong>CCN:</strong></td>
                        <td>
                          <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 10px;">
                            @if (azuriranjeCCN == false) { 
                              <span>{{ ulogovan.broj_kreditne_kartice }}</span>
                            } @else { 
                              <input type="text" [(ngModel)]="korisnik.broj_kreditne_kartice" 
                                    [value]="ulogovan.broj_kreditne_kartice" 
                                    (input)="proveriKarticu()" 
                                    style="width: 220px; max-width: 100%;">
                            }
                            <img [src]="putanjaSlike" alt="Tip kartice" width="40" height="25" 
                                [style.visibility]="putanjaSlike ? 'visible' : 'hidden'">
                          </div>
                        </td>
                        <td style="width: auto;">
                          @if (azuriranjeCCN == false) { 
                            <button (click)="setAzuriranjeCCN()">Azuriraj broj kreditne kartice</button> 
                          } @else { 
                            <button (click)="azurirajCCN()">Azuriraj broj kreditne kartice</button> 
                          }
                        </td>
                      </tr>
                    </table>

                    <div class="all-errors">
                      @if (message != "") { 
                        <div class="error-message">
                          <img src="assets/icons/warning.png" alt="Warning" class="error-icon">
                          {{message}}
                        </div> 
                      }
                      @if (messageSlika != "") { 
                        <div class="error-message">
                          <img src="assets/icons/warning.png" alt="Warning" class="error-icon">
                          {{messageSlika}}
                        </div> 
                      }
                      @if (messageIme != "") { 
                        <div class="error-message">
                          <img src="assets/icons/warning.png" alt="Warning" class="error-icon">
                          {{messageIme}}
                        </div> 
                      }
                      @if (messagePrezime != "") { 
                        <div class="error-message">
                          <img src="assets/icons/warning.png" alt="Warning" class="error-icon">
                          {{messagePrezime}}
                        </div> 
                      }
                      @if (messageAdresa != "") { 
                        <div class="error-message">
                          <img src="assets/icons/warning.png" alt="Warning" class="error-icon">
                          {{messageAdresa}}
                        </div> 
                      }
                      @if (messageTelefon != "") { 
                        <div class="error-message">
                          <img src="assets/icons/warning.png" alt="Warning" class="error-icon">
                          {{messageTelefon}}
                        </div> 
                      }
                      @if (messageEMail != "") { 
                        <div class="error-message">
                          <img src="assets/icons/warning.png" alt="Warning" class="error-icon">
                          {{messageEMail}}
                        </div> 
                      }
                      @if (messageCCN != "") { 
                        <div class="error-message">
                          <img src="assets/icons/warning.png" alt="Warning" class="error-icon">
                          {{messageCCN}}
                        </div> 
                      }
                    </div>
                  </div>
                </div>
              </div>
            </div>
        }

        @if (activeSection == 'vikendice') {
          <div class="white-box">
            <div class="scrollable-content">
                <div class="vikendice-section">
                  <div class="d-flex align-items-center gap-2 mb-3 justify-content-center flex-wrap">
                    <span class="fw-bold">Pretraga:</span>
                    <input type="text" class="form-control form-control-sm w-auto" [(ngModel)]="filterNaziv" placeholder="Naziv" (ngModelChange)="primeniFilter()">
                    <input type="text" class="form-control form-control-sm w-auto" [(ngModel)]="filterMesto" placeholder="Mesto" (ngModelChange)="primeniFilter()">
                  </div>

                  <div class="d-flex align-items-center gap-2 mb-3 justify-content-center flex-wrap">
                    <span class="fw-bold">Sortiraj po:</span>
                    <button class="btn-vikendice" (click)="sortiraj('naziv', 'asc')">Naziv ↑</button>
                    <button class="btn-vikendice" (click)="sortiraj('naziv', 'desc')">Naziv ↓</button>
                    <button class="btn-vikendice" (click)="sortiraj('mesto', 'asc')">Mesto ↑</button>
                    <button class="btn-vikendice" (click)="sortiraj('mesto', 'desc')">Mesto ↓</button>
                  </div>

                  <div class="table-scroll">
                    <table class="table table-striped table-bordered mb-0">
                      <thead class="table-dark">
                        <tr>
                          <th>Naziv</th>
                          <th>Mesto</th>
                          <th>Prosecna ocena</th>
                        </tr>
                      </thead>
                      <tbody>
                        @for (v of filtriraneVikendice; track v.id){
                          <tr>
                            <td><a [routerLink]="['/vikendica', v.naziv]" [queryParams]="{ naziv: v.naziv }">{{v.naziv}}</a></td>
                            <td>{{v.mesto}}</td>
                            <td>
                              <div class="stars">
                                @if (prosecneOcene[v.id] != 0) {
                                  <span class="ocena">
                                    {{ prosecneOcene[v.id] }}
                                  </span>
                                  <div class="zvezdice">
                                      @for(star of getStars(prosecneOcene[v.id]); track star) {
                                        <span class="star">
                                          @if(star === 'full') {
                                            <span class="full">★</span>
                                          } @else if(star === 'half') {
                                            <span class="half">★</span>
                                          } @else {
                                            <span class="empty">★</span>
                                          }
                                        </span>
                                      }
                                  </div>
                                }
                                @else {
                                  <span class="ocena_NA">
                                    N/A
                                  </span>
                                }
                              </div>
                            </td>
                          </tr>
                        }
                      </tbody>
                    </table>
                  </div>
                </div>
            </div>
          </div>
        }

        @if (activeSection == 'rezervacije') { 
          <div class="d-flex flex-column align-items-center w-100">
            <div class="white-box rezervacije-box">
              <div class="scrollable-content">
                <h3 class="center-title">Aktivne rezervacije</h3>
                <div class="rezervacije-section table-scroll">
                  @if (messageOtkazivanje != "") { 
                    <div class="error-message2">
                      <img src="assets/icons/warning.png" alt="Warning" class="error-icon">
                      {{messageOtkazivanje}}
                    </div> 
                  }
                  <table class="table table-striped table-bordered mb-0">
                    <thead class="table-dark">
                      <tr>
                        <th>Datum pocetka rezervacije</th>
                        <th>Datum kraja rezervacije</th>
                        <th>Naziv vikendice</th>
                        <th>Mesto vikendice</th>
                        <th>Komentar</th>
                        <th>Akcije</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (r of mojeAktivneRezervacije; track r.id){
                        @if (r.status != 'otkazana') {
                          <tr [class.zeleno]="r.status == 'potvrdjena'" [class.crveno]="r.status == 'odbijena'">
                            <td>{{formatDate(r.datum_pocetka)}}</td>
                            <td>{{formatDate(r.datum_kraja)}}</td>
                            <td>{{r.vikendica?.naziv}}</td>
                            <td>{{r.vikendica?.mesto}}</td>
                            <td>{{ r.status == 'odbijena' ? r.komentarZaOdbijanje : '' }}</td>
                            @if (r.status != 'odbijena' && r.status != 'otkazana') {
                              <td>
                                <button class="small-btn" (click)="otkaziRezervaciju(r)">Otkazi rezervaciju</button>
                              </td>
                            }
                          </tr> 
                        }
                      }
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="white-box rezervacije-box">
              <div class="scrollable-content">
                <h3 class="center-title">Arhivirane rezervacije</h3>
                <div class="rezervacije-section table-scroll">
                  @if (messageRecenzija != "") { 
                    <div class="error-message1">
                      <img src="assets/icons/warning.png" alt="Warning" class="error-icon">
                      {{messageRecenzija}}
                    </div> 
                  }
                  <table class="table table-striped table-bordered mb-0">
                    <thead class="table-dark">
                      <tr>
                        <th>Datum pocetka rezervacije</th>
                        <th>Naziv vikendice</th>
                        <th>Komentar i ocena</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (r of rezervacijeSaRecenzijama; track r.rezervacija.id) {
                        <tr>
                          <td>{{formatDate(r.rezervacija.datum_pocetka)}}</td>
                          <td>{{r.rezervacija.vikendica?.naziv}}</td>
                          <td>
                            @if (r.recenzija) {
                              <div class="recenzija-prikaz">
                                <p class="recenzija-komentar">{{ r.recenzija.komentar }}</p>

                                <div class="ocena-zvezdica">
                                  <span class="ocena">{{ r.recenzija.ocena }}</span>
                                  <span class="zvezdica">★</span>
                                </div>
                              </div>
                            }
                            @else {
                              @if (ostavljanjeRecenzije == false || aktivnaRezervacijaZaRecenziju != r.rezervacija) {
                                <button class="small-btn" (click)="ostavljanjeRecenzijeF(r.rezervacija)">Ostavi recenziju</button>
                              }
                              @else {
                                <textarea [(ngModel)]="novaRecenzija.komentar" maxlength="500" rows="4" cols="20"></textarea>
                                <div class="star-rating">
                                  @for (star of [1,2,3,4,5]; track star) {
                                    <span (click)="setRating(star)"
                                          (mouseenter)="hoverRating(star)"
                                          (mouseleave)="hoverRating(0)"
                                          [class.filled]="(hoveredRating || novaRecenzija.ocena) >= star">
                                      ★
                                    </span>
                                  }
                                </div>
                                <button class="small-btn" (click)="ostaviRecenziju(r.rezervacija)">Ostavi recenziju</button>
                              }
                            }
                          </td>
                        </tr>
                      }
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        }
  </main>

  <footer class="bg-light py-3 text-center shadow-sm mt-auto">
    <p><strong>&copy; 2025 Planinska vikendica</strong></p>
  </footer>
</div>
